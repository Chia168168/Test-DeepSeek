<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENG 圖片處理工具 v2.2 - 按鈕顯示優化版</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #0033A0;
            --secondary-color: #005B99;
            --background-color: #E6F0FA;
            --light-background: #F5F8FA;
            --error-color: #ff3333;
            --success-color: #33cc33;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-background);
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin: 0 0 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .version {
            font-size: 14px;
            color: var(--secondary-color);
            font-weight: normal;
        }
        .section {
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .file-button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-button, .clear-button {
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        .file-button:hover, .clear-button:hover {
            background-color: var(--secondary-color);
            color: #FFFFFF;
        }
        .process-button {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        .process-button:hover {
            background-color: var(--secondary-color);
            color: #FFFFFF;
        }
        .process-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #downloadButton {
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 4px;
            color: #FFFFFF;
            display: none;
            transition: background-color 0.2s;
        }
        #downloadButton:hover {
            background-color: var(--primary-color);
        }
        #fileList {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            background-color: #FFFFFF;
        }
        .file-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .thumbnail {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-size: 12px;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            resize: vertical;
            background-color: #FFFFFF;
            padding: 8px;
        }
        .hidden {
            display: none !important;
        }
        .mode-specific {
            display: none;
        }
        .controls div {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        label {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 500;
            min-width: 80px;
        }
        input[type="number"] {
            width: 100px;
            padding: 6px;
            font-size: 14px;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            background-color: #FFFFFF;
        }
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .mode-buttons, .dimension-buttons, .size-buttons, .quality-buttons, .format-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .mode-button, .dimension-button, .size-button, .quality-button, .format-button {
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        .mode-button.active, .dimension-button.active, .size-button.active, .quality-button.active, .format-button.active {
            background-color: var(--primary-color);
            color: #FFFFFF;
            border-color: var(--primary-color);
        }
        .mode-button:hover, .dimension-button:hover, .size-button:hover, .quality-button:hover, .format-button:hover {
            background-color: var(--secondary-color);
            color: #FFFFFF;
        }
        .progress-container {
            display: none;
            margin-top: 10px;
            width: 100%;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 12px;
            color: var(--primary-color);
            text-align: center;
            margin-top: 5px;
        }
        .error-message {
            display: none;
            background-color: #ffe6e6;
            border: 1px solid var(--error-color);
            padding: 10px;
            border-radius: 4px;
            color: var(--error-color);
            font-size: 12px;
            margin-top: 10px;
        }
        .success-message {
            display: none;
            background-color: #e6ffe6;
            border: 1px solid var(--success-color);
            padding: 10px;
            border-radius: 4px;
            color: var(--success-color);
            font-size: 12px;
            margin-top: 10px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-top: 10px;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--secondary-color);
            color: #FFFFFF;
            text-align: center;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .help-text {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 5px;
        }
        .performance-note {
            font-size: 12px;
            color: var(--secondary-color);
            background-color: #fff;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid var(--secondary-color);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-ready {
            background-color: var(--success-color);
        }
        .status-processing {
            background-color: orange;
        }
        .status-complete {
            background-color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TENG 圖片處理工具 <span class="version">v2.2 - 按鈕顯示優化版</span></h1>
        
        <div class="section">
            <label>處理模式</label>
            <div class="mode-buttons">
                <button class="mode-button active" data-mode="resize" onclick="switchMode('resize')">尺寸調整與格式轉換</button>
                <button class="mode-button" data-mode="base64" onclick="switchMode('base64')">Base64 互轉</button>
            </div>
        </div>
        
        <div class="section file-button-container">
            <div id="imageFileInputContainer">
                <label>圖片檔案</label>
                <button class="file-button" onclick="triggerFileInput('imageInput')">選擇圖片</button>
                <input type="file" id="imageInput" accept="image/*,.heic,.heif" multiple class="hidden">
                <div class="help-text">支援 JPEG, PNG, HEIC, HEIF</div>
            </div>
            <div id="imageFolderInputContainer">
                <label>圖片資料夾</label>
                <button class="file-button" onclick="triggerFileInput('imageFolderInput')">選擇資料夾</button>
                <input type="file" id="imageFolderInput" webkitdirectory accept="image/*,.heic,.heif" class="hidden">
                <div class="help-text">僅支援 Chrome, Edge, Safari</div>
            </div>
            <div id="base64FileInputContainer" class="mode-specific" data-mode="base64">
                <label>Base64 檔案</label>
                <button class="file-button" onclick="triggerFileInput('base64FileInput')">選擇檔案</button>
                <input type="file" id="base64FileInput" accept=".txt" multiple class="hidden">
                <div class="help-text">支援 .txt 檔案</div>
            </div>
            <div id="base64FolderInputContainer" class="mode-specific" data-mode="base64">
                <label>Base64 資料夾</label>
                <button class="file-button" onclick="triggerFileInput('base64FolderInput')">選擇資料夾</button>
                <input type="file" id="base64FolderInput" webkitdirectory class="hidden">
                <div class="help-text">僅支援 Chrome, Edge, Safari</div>
            </div>
            <div>
                <label>清空</label>
                <button class="clear-button" onclick="clearFiles()">清空檔案</button>
            </div>
        </div>
        
        <div class="section">
            <h3 id="fileListHeader" style="margin: 0; font-size: 16px; color: #0033A0;">
                <span class="status-indicator status-ready"></span>已選擇的檔案：<span id="fileCount">0</span> 張
            </h3>
            <div id="fileList"></div>
        </div>
        
        <div id="resizeOptions" class="section mode-specific controls" data-mode="resize">
            <div>
                <label>尺寸設定</label>
                <div class="dimension-buttons">
                    <button class="dimension-button active" data-mode="width" onclick="switchDimensionMode('width')">固定寬度</button>
                    <button class="dimension-button" data-mode="height" onclick="switchDimensionMode('height')">固定高度</button>
                    <button class="dimension-button" data-mode="both" onclick="switchDimensionMode('both')">寬度與高度</button>
                </div>
            </div>
            <div id="widthContainer">
                <label>寬度 (px)</label>
                <div class="size-buttons">
                    <button class="size-button" data-value="256" onclick="setSize('width', '256')">256</button>
                    <button class="size-button" data-value="512" onclick="setSize('width', '512')">512</button>
                    <button class="size-button active" data-value="1024" onclick="setSize('width', '1024')">1024</button>
                    <button class="size-button" data-value="1280" onclick="setSize('width', '1280')">1280</button>
                    <button class="size-button" data-value="custom" onclick="setSize('width', 'custom')">自訂</button>
                </div>
                <input type="number" id="widthInput" min="1" class="hidden" placeholder="輸入寬度">
            </div>
            <div id="heightContainer">
                <label>高度 (px)</label>
                <div class="size-buttons">
                    <button class="size-button" data-value="256" onclick="setSize('height', '256')">256</button>
                    <button class="size-button" data-value="512" onclick="setSize('height', '512')">512</button>
                    <button class="size-button active" data-value="1024" onclick="setSize('height', '1024')">1024</button>
                    <button class="size-button" data-value="1280" onclick="setSize('height', '1280')">1280</button>
                    <button class="size-button" data-value="custom" onclick="setSize('height', 'custom')">自訂</button>
                </div>
                <input type="number" id="heightInput" min="1" class="hidden" placeholder="輸入高度">
            </div>
            <div>
                <label>保持比例</label>
                <input type="checkbox" id="aspectRatio" checked onchange="updateDimensions()">
            </div>
            <div id="qualityContainer">
                <label>品質</label>
                <div class="quality-buttons">
                    <button class="quality-button" data-value="0.5" onclick="setQuality('0.5')">50%</button>
                    <button class="quality-button" data-value="0.7" onclick="setQuality('0.7')">70%</button>
                    <button class="quality-button active" data-value="0.9" onclick="setQuality('0.9')">90%</button>
                    <button class="quality-button" data-value="0.95" onclick="setQuality('0.95')">95%</button>
                    <button class="quality-button" data-value="custom" onclick="setQuality('custom')">自訂</button>
                </div>
                <input type="number" id="qualityInput" min="0" max="100" class="hidden" placeholder="0-100">
            </div>
        </div>
        
        <div id="base64InputSection" class="section mode-specific" data-mode="base64">
            <label>Base64 字串</label>
            <textarea id="base64Text" placeholder="輸入 Base64 字串（例如 data:image/jpeg;base64,...）"></textarea>
        </div>
        
        <div class="section">
            <label>輸出格式</label>
            <div class="format-buttons">
                <button class="format-button active" data-value="image/jpeg" onclick="setFormat('image/jpeg')">JPEG</button>
                <button class="format-button" data-value="image/png" onclick="setFormat('image/png')">PNG</button>
                <button class="format-button" data-value="image/webp" onclick="setFormat('image/webp')">WebP</button>
            </div>
        </div>
        
        <div class="performance-note">
            <strong>效能提示：</strong> 處理大量圖片時，系統會自動分批處理以避免瀏覽器卡頓。處理過程中請勿關閉頁面。
        </div>
        
        <div class="section">
            <div class="file-button-container" id="processButtonsContainer">
                <button id="resizeButton" class="process-button mode-specific" data-mode="resize" onclick="processResize()">調整尺寸與格式</button>
                <button id="toBase64Button" class="process-button mode-specific" data-mode="base64" onclick="processImageToBase64()">圖片轉 Base64</button>
                <button id="fromBase64Button" class="process-button mode-specific" data-mode="base64" onclick="processBase64ToImage()">Base64 轉圖片</button>
            </div>
        </div>
        
        <div class="section progress-container" id="progressContainer">
            <div class="progress-header">
                <span id="progressTitle">處理進度</span>
                <span id="progressPercentage">0%</span>

            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">等待中...</div>
            <div id="timeRemaining" class="progress-text"></div>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <div class="section">
            <button id="downloadButton">下載結果</button>
        </div>
        
        <div class="section">
            <h3 style="margin: 0; font-size: 16px; color: #0033A0;">縮圖預覽</h3>
            <div id="previewContainer" class="thumbnail-container"></div>
        </div>
        
        <div id="base64Output" class="section mode-specific" data-mode="base64">
            <h3 style="margin: 0; font-size: 16px; color: #0033A0;">Base64 內容</h3>
            <div id="base64OutputContainer"></div>
        </div>
        
        <div class="tooltip">
            <span style="font-size: 12px; color: #005B99;">使用說明</span>
            <span class="tooltip-text">支援圖片尺寸調整、格式轉換（尺寸調整預設 JPEG，Base64 模式預設 PNG，品質 90%）及 Base64 互轉。HEIC/HEIF 支援，多檔案打包為 ZIP。請勿分享敏感 Base64 字串。資料夾選擇僅支援 Chrome、Edge 和 Safari。</span>
        </div>
    </div>

    <script>
    // 这里放置完整的JavaScript代码
    // 由于代码较长，我将提供关键部分
    
    let originalImages = [];
    let processedBlobs = [];
    let base64Data = [];
    let downloadBlob = null;
    let downloadFileName = '';
    let currentDimensionMode = 'width';
    let currentWidthValue = '1024';
    let currentHeightValue = '1024';
    let currentQualityValue = '0.9';
    let currentFormatValue = 'image/jpeg';
    let isProcessing = false;
    let startTime = null;
    let processedCount = 0;
    let totalToProcess = 0;
    let selectedFileType = null;

    // 检查浏览器是否支持 webkitdirectory
    function checkDirectorySupport() {
        const input = document.createElement('input');
        input.setAttribute('webkitdirectory', '');
        return 'webkitdirectory' in input;
    }

    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // 触发文件输入
    function triggerFileInput(inputId) {
        if (isProcessing) {
            showError('请等待当前处理完成后再选择文件');
            return;
        }
        
        const mode = document.querySelector('.mode-button.active').dataset.mode;
        if ((inputId === 'base64FolderInput' || inputId === 'base64FileInput') && mode !== 'base64') {
            showError('请先切换到「Base64 互转」模式！');
            return;
        }
        const input = document.getElementById(inputId);
        if (input) {
            if ((inputId === 'base64FolderInput' || inputId === 'imageFolderInput') && !checkDirectorySupport()) {
                showError('此浏览器不支持文件夹选择，请使用 Chrome、Edge 或 Safari！');
                return;
            }
            input.click();
        } else {
            showError(`无法找到输入元素（${inputId}），请重新加载页面！`);
        }
    }

    // 更新处理按钮和输入按钮的显示状态
    function updateProcessButtons() {
        const mode = document.querySelector('.mode-button.active').dataset.mode;
        const resizeButton = document.getElementById('resizeButton');
        const toBase64Button = document.getElementById('toBase64Button');
        const fromBase64Button = document.getElementById('fromBase64Button');
        const imageFileInputContainer = document.getElementById('imageFileInputContainer');
        const imageFolderInputContainer = document.getElementById('imageFolderInputContainer');
        const base64FileInputContainer = document.getElementById('base64FileInputContainer');
        const base64FolderInputContainer = document.getElementById('base64FolderInputContainer');

        // 重置所有按钮为显示状态
        resizeButton.style.display = 'block';
        toBase64Button.style.display = 'block';
        fromBase64Button.style.display = 'block';
        imageFileInputContainer.style.display = 'block';
        imageFolderInputContainer.style.display = 'block';
        base64FileInputContainer.style.display = 'block';
        base64FolderInputContainer.style.display = 'block';

        // 根据模式和选择的文件类型调整显示
        if (mode === 'resize') {
            // 尺寸调整模式：隐藏Base64相关按钮
            toBase64Button.style.display = 'none';
            fromBase64Button.style.display = 'none';
            base64FileInputContainer.style.display = 'none';
            base64FolderInputContainer.style.display = 'none';
        } else if (mode === 'base64') {
            // Base64模式：根据选择的文件类型调整显示
            if (selectedFileType === 'image') {
                fromBase64Button.style.display = 'none';
                base64FileInputContainer.style.display = 'none';
                base64FolderInputContainer.style.display = 'none';
            } else if (selectedFileType === 'base64') {
                toBase64Button.style.display = 'none';
                imageFileInputContainer.style.display = 'none';
                imageFolderInputContainer.style.display = 'none';
            }
            // 如果没有选择文件，则显示所有按钮
        }
    }

    // 模式切换
    function switchMode(mode) {
        if (isProcessing) {
            showError('请等待当前处理完成后再切换模式');
            return;
        }
        
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        document.querySelectorAll('.mode-specific').forEach(el => {
            el.style.display = el.dataset.mode === mode ? 'block' : 'none';
        });
        currentFormatValue = mode === 'resize' ? 'image/jpeg' : 'image/png';
        document.querySelectorAll('.format-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === currentFormatValue);
        });
        toggleQualityContainer();
        clearFiles(); // 清空文件并重置按钮
        if (mode === 'resize') {
            switchDimensionMode(currentDimensionMode);
        }
    }

    // 尺寸模式切换
    function switchDimensionMode(mode) {
        currentDimensionMode = mode;
        document.querySelectorAll('.dimension-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        const widthContainer = document.getElementById('widthContainer');
        const heightContainer = document.getElementById('heightContainer');
        widthContainer.classList.toggle('hidden', mode === 'height');
        heightContainer.classList.toggle('hidden', mode === 'width');
        updateDimensionInputs();
        updateFileList();
    }

    // 设置宽度或高度值
    function setSize(type, value) {
        const buttons = document.querySelectorAll(`#${type}Container .size-button`);
        buttons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === value);
        });
        const input = document.getElementById(`${type}Input`);
        input.classList.toggle('hidden', value !== 'custom');
        if (type === 'width') {
            currentWidthValue = value;
        } else {
            currentHeightValue = value;
        }
        updateDimensions();
        updateFileList();
    }

    // 设置品质值
    function setQuality(value) {
        document.querySelectorAll('.quality-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === value);
        });
        const input = document.getElementById('qualityInput');
        input.classList.toggle('hidden', value !== 'custom');
        currentQualityValue = value;
        updateFileList();
    }

    // 设置输出格式
    function setFormat(value) {
        document.querySelectorAll('.format-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === value);
        });
        currentFormatValue = value;
        toggleQualityContainer();
        updateFileList();
    }

    // 清空文件
    function clearFiles() {
        if (isProcessing) {
            showError('请等待当前处理完成后再清空文件');
            return;
        }
        
        originalImages = [];
        processedBlobs = [];
        base64Data = [];
        selectedFileType = null; // 重置文件类型
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('previewContainer').innerHTML = '';
        document.getElementById('base64OutputContainer').innerHTML = '';
        document.getElementById('base64Text').value = '';
        document.getElementById('downloadButton').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('fileCount').textContent = '0';
        document.querySelector('.status-indicator').className = 'status-indicator status-ready';
        currentWidthValue = '1024';
        currentHeightValue = '1024';
        currentQualityValue = '0.9';
        document.querySelectorAll('.size-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === '1024');
        });
        document.querySelectorAll('.quality-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === '0.9');
        });
        document.getElementById('widthInput').classList.add('hidden');
        document.getElementById('heightInput').classList.add('hidden');
        document.getElementById('qualityInput').classList.add('hidden');
        document.querySelectorAll('.format-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === currentFormatValue);
        });
        updateProcessButtons(); // 更新按钮状态
        updateFileList();
    }

    // 显示错误消息
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        const successDiv = document.getElementById('successMessage');
        successDiv.style.display = 'none';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    // 显示成功消息
    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.style.display = 'none';
        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 5000);
    }

    // 处理文件输入
    document.getElementById('imageInput').addEventListener('change', e => handleFileSelect(e, true, 'image'));
    document.getElementById('imageFolderInput').addEventListener('change', e => handleFileSelect(e, true, 'image'));
    document.getElementById('base64FileInput').addEventListener('change', e => handleFileSelect(e, true, 'base64'));
    document.getElementById('base64FolderInput').addEventListener('change', e => {
        handleFileSelect(e, true, 'base64');
    });

    // 下载按钮
    document.getElementById('downloadButton').addEventListener('click', () => {
        if (downloadBlob && downloadFileName) {
            saveAs(downloadBlob, downloadFileName);
        } else {
            showError('无可下载的文件，请先处理文件！');
        }
    });

    function handleFileSelect(e, append = false, type = 'image') {
        const files = e.target.files;
        if (!files || files.length === 0) {
            showError('未选择任何文件，请重新选择！');
            return;
        }

        if (!append) {
            clearFiles();
        }

        let validFiles = Array.from(files);
        if (type === 'base64') {
            validFiles = validFiles.filter(file => file.name.toLowerCase().endsWith('.txt'));
            if (validFiles.length === 0) {
                showError('Base64 文件夹中无 .txt 文件，请选择包含 .txt 的文件夹！');
                return;
            }
        } else if (type === 'image') {
            validFiles = validFiles.filter(file => {
                const ext = file.name.toLowerCase();
                return ext.match(/\.(jpeg|jpg|png|gif|bmp|webp|heic|heif)$/);
            });
            if (validFiles.length === 0) {
                showError('图片文件夹中无支持的图片文件（JPEG、PNG、GIF、BMP、WebP、HEIC、HEIF），请重新选择！');
                return;
            }
        }

        // 设置文件类型并更新按钮
        selectedFileType = type;
        updateProcessButtons();

        // 显示加载中的状态
        document.querySelector('.status-indicator').className = 'status-indicator status-processing';
        document.getElementById('fileCount').textContent = validFiles.length;
        
        // 分批处理文件
        processFilesInBatches(validFiles, type, 0);
    }

    function processFilesInBatches(files, type, startIndex) {
        const batchSize = 5;
        const endIndex = Math.min(startIndex + batchSize, files.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            const file = files[i];
            if (originalImages.some(img => img.file.name === file.name && img.file.size === file.size)) {
                showError(`文件 ${file.name} 已存在，请选择其他文件！`);
                continue;
            }

            if (type === 'image') {
                const isHeicHeif = file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
                if (isHeicHeif) {
                    heic2any({ blob: file, toType: 'image/png' })
                        .then(result => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                handleImageLoad(file, e.target.result, originalImages.length, 'image');
                                if (i === files.length - 1) {
                                    document.querySelector('.status-indicator').className = 'status-indicator status-complete';
                                }
                            };
                            reader.readAsDataURL(result);
                        })
                        .catch(err => {
                            showError(`HEIC/HEIF 转换失败 (${file.name})：${err.message}`);
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                handleImageLoad(file, e.target.result, originalImages.length, 'image');
                                if (i === files.length - 1) {
                                    document.querySelector('.status-indicator').className = 'status-indicator status-complete';
                                }
                            };
                            reader.readAsDataURL(file);
                        });
                } else {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        handleImageLoad(file, e.target.result, originalImages.length, 'image');
                        if (i === files.length - 1) {
                            document.querySelector('.status-indicator').className = 'status-indicator status-complete';
                        }
                    };
                    reader.readAsDataURL(file);
                }
            } else if (type === 'base64') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    handleBase64FileLoad(file, e.target.result, originalImages.length);
                    if (i === files.length - 1) {
                        document.querySelector('.status-indicator').className = 'status-indicator status-complete';
                    }
                };
                reader.readAsText(file);
            }
        }
        
        if (endIndex < files.length) {
            setTimeout(() => {
                processFilesInBatches(files, type, endIndex);
            }, 100);
        }
    }

    function handleImageLoad(file, imageSrc, index, type) {
        const img = new Image();
        img.onload = function() {
            originalImages.push({ file, img, type, base64: type === 'image' ? imageSrc : null });
            updateFileList();
            const thumbnail = document.createElement('img');
            thumbnail.src = imageSrc;
            thumbnail.className = 'thumbnail';
            thumbnail.dataset.index = index;
            thumbnail.title = file.name;
            document.getElementById('previewContainer').appendChild(thumbnail);
            if (document.querySelector('.mode-button.active').dataset.mode === 'resize') {
                updateDimensionInputs();
            }
        };
        img.onerror = function() {
            showError(`无法加载图片：${file.name}，请确认文件格式是否为 JPEG、PNG、HEIC 或 HEIF！`);
        };
        img.src = imageSrc;
    }

    async function handleBase64FileLoad(file, text, index) {
        let base64String = text.trim();
        if (!base64String) {
            showError(`Base64 文件 ${file.name} 内容为空，请检查文件！`);
            return;
        }

        const prefixes = [
            'data:image/jpeg;base64,',
            'data:image/png;base64,',
            'data:image/webp;base64,',
            'data:image/gif;base64,'
        ];

        if (base64String.startsWith('data:image/')) {
            await tryImageLoad(file, base64String, index);
            return;
        }

        for (let prefix of prefixes) {
            const testString = prefix + base64String;
            const isValid = await tryImageLoad(file, testString, index, false);
            if (isValid) {
                originalImages.push({ file, img: new Image(), type: 'base64', base64: testString });
                updateFileList();
                const thumbnail = document.createElement('img');
                thumbnail.src = testString;
                thumbnail.className = 'thumbnail';
                thumbnail.dataset.index = index;
                thumbnail.title = file.name;
                document.getElementById('previewContainer').appendChild(thumbnail);
                return;
            }
        }

        showError(`无法加载 Base64 文件：${file.name}，请确认内容是否为有效的图片 Base64 字符串！`);
    }

    async function tryImageLoad(file, base64String, index, addToImages = true) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                if (addToImages) {
                    originalImages.push({ file, img, type: 'base64', base64: base64String });
                    updateFileList();
                    const thumbnail = document.createElement('img');
                    thumbnail.src = base64String;
                    thumbnail.className = 'thumbnail';
                    thumbnail.dataset.index = index;
                    thumbnail.title = file.name;
                    document.getElementById('previewContainer').appendChild(thumbnail);
                }
                resolve(true);
            };
            img.onerror = function() {
                resolve(false);
            };
            img.src = base64String;
        });
    }

    function updateFileList() {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';
        const mode = document.querySelector('.mode-button.active').dataset.mode;
        document.getElementById('fileCount').textContent = originalImages.length;

        originalImages.forEach((item, index) => {
            const listItem = document.createElement('div');
            listItem.className = 'file-item';
            let text = `${item.file.name} (${item.type === 'image' ? '图片' : 'Base64'})`;
            if (mode === 'resize' && item.type === 'image') {
                const widthInput = parseInt(document.getElementById('widthInput').value) || item.img.width;
                const heightInput = parseInt(document.getElementById('heightInput').value) || item.img.height;
                const dimensionMode = currentDimensionMode;
                const aspectRatio = document.getElementById('aspectRatio').checked;

                let width = dimensionMode !== 'height' && currentWidthValue === 'custom' ? widthInput : parseInt(currentWidthValue) || item.img.width;
                let height = dimensionMode !== 'width' && currentHeightValue === 'custom' ? heightInput : parseInt(currentHeightValue) || item.img.height;

                if (aspectRatio) {
                    const ratio = item.img.height / item.img.width;
                    if (dimensionMode === 'width' && currentWidthValue !== '') {
                        height = Math.round(width * ratio);
                    } else if (dimensionMode === 'height' && currentHeightValue !== '') {
                        width = Math.round(height / ratio);
                    } else if (dimensionMode === 'both' && currentWidthValue !== '' && currentHeightValue !== '') {
                        height = Math.round(width * ratio);
                    }
                } else if (dimensionMode === 'width') {
                    height = item.img.height;
                } else if (dimensionMode === 'height') {
                    width = item.img.width;
                }

                text += ` | 原尺寸: ${item.img.width}x${item.img.height}`;
                if (width && height) {
                    text += ` | 调整后: ${width}x${height}`;
                }
            }
            listItem.textContent = text;
            fileList.appendChild(listItem);
        });
    }

    function toggleQualityContainer() {
        const qualityContainer = document.getElementById('qualityContainer');
        qualityContainer.style.display = currentFormatValue === 'image/png' ? 'none' : 'block';
        updateFileList();
    }

    function updateDimensionInputs() {
        if (!originalImages[0]) return;
        const width = originalImages[0].img.width;
        const height = originalImages[0].img.height;
        const options = ['256', '512', '1024', '1280'];
        currentWidthValue = options.includes(width.toString()) ? width.toString() : '1024';
        currentHeightValue = options.includes(height.toString()) ? height.toString() : '1024';
        document.querySelectorAll('#widthContainer .size-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === currentWidthValue);
        });
        document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === currentHeightValue);
        });
        document.getElementById('widthInput').classList.toggle('hidden', currentWidthValue !== 'custom');
        document.getElementById('heightInput').classList.toggle('hidden', currentHeightValue !== 'custom');
        updateDimensions();
    }

    function updateDimensions() {
        if (!originalImages[0]) return;

        const widthInput = parseInt(document.getElementById('widthInput').value) || 0;
        const heightInput = parseInt(document.getElementById('heightInput').value) || 0;
        const aspectRatio = document.getElementById('aspectRatio').checked;

        let width = currentWidthValue === 'custom' ? (widthInput || originalImages[0].img.width) : parseInt(currentWidthValue);
        let height = currentHeightValue === 'custom' ? (heightInput || originalImages[0].img.height) : parseInt(currentHeightValue);

        if (aspectRatio) {
            const ratio = originalImages[0].img.height / originalImages[0].img.width;
            if (currentDimensionMode === 'width' && width > 0) {
                currentHeightValue = 'custom';
                height = Math.round(width * ratio);
                document.getElementById('heightInput').value = height;
                document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'custom');
                });
                if (!document.getElementById('heightContainer').classList.contains('hidden')) {
                    document.getElementById('heightInput').classList.remove('hidden');
                }
            } else if (currentDimensionMode === 'height' && height > 0) {
                currentWidthValue = 'custom';
                width = Math.round(height / ratio);
                document.getElementById('widthInput').value = width;
                document.querySelectorAll('#widthContainer .size-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'custom');
                });
                if (!document.getElementById('widthContainer').classList.contains('hidden')) {
                    document.getElementById('widthInput').classList.remove('hidden');
                }
            } else if (currentDimensionMode === 'both' && width > 0) {
                currentHeightValue = 'custom';
                height = Math.round(width * ratio);
                document.getElementById('heightInput').value = height;
                document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'custom');
                });
                document.getElementById('heightInput').classList.remove('hidden');
            }
        }
        updateFileList();
    }

    // 防抖处理输入框
    const debouncedUpdateDimensions = debounce(updateDimensions, 300);
    document.getElementById('widthInput').addEventListener('input', debouncedUpdateDimensions);
    document.getElementById('heightInput').addEventListener('input', debouncedUpdateDimensions);
    document.getElementById('qualityInput').addEventListener('input', updateFileList);
    document.getElementById('aspectRatio').addEventListener('change', updateDimensions);

    function updateProgress(current, total, processedItem = null) {
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressPercentage = document.getElementById('progressPercentage');
        const timeRemaining = document.getElementById('timeRemaining');
        
        progressContainer.style.display = 'block';
        const percentage = total > 0 ? (current / total) * 100 : 0;
        progressFill.style.width = `${percentage}%`;
        progressPercentage.textContent = `${Math.round(percentage)}%`;
        
        if (processedItem) {
            progressText.textContent = `处理中：${current}/${total} (${processedItem})`;
        } else {
            progressText.textContent = `处理中：${current}/${total}`;
        }
        
        if (startTime && current > 0) {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const timePerItem = elapsedTime / current;
            const remainingItems = total - current;
            const remainingTime = timePerItem * remainingItems;
            
            if (remainingTime > 60) {
                timeRemaining.textContent = `预计剩余时间：${Math.round(remainingTime / 60)} 分钟`;
            } else {
                timeRemaining.textContent = `预计剩余时间：${Math.round(remainingTime)} 秒`;
            }
        }
    }

    function disableUI() {
        isProcessing = true;
        document.querySelectorAll('.file-button, .process-button, .clear-button').forEach(btn => {
            btn.disabled = true;
        });
        document.querySelector('.status-indicator').className = 'status-indicator status-processing';
    }

    function enableUI() {
        isProcessing = false;
        document.querySelectorAll('.file-button, .process-button, .clear-button').forEach(btn => {
            btn.disabled = false;
        });
        document.querySelector('.status-indicator').className = 'status-indicator status-complete';
    }

    async function processResize() {
        if (originalImages.length === 0 || !originalImages.some(item => item.type === 'image')) {
            showError('请先选择图片文件！');
            return;
        }

        disableUI();
        const format = currentFormatValue;
        const widthInput = parseInt(document.getElementById('widthInput').value);
        const heightInput = parseInt(document.getElementById('heightInput').value);
        const aspectRatio = document.getElementById('aspectRatio').checked;
        const qualityInput = parseInt(document.getElementById('qualityInput').value);
        const quality = currentQualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentQualityValue);

        const zip = new JSZip();
        processedBlobs = [];
        document.getElementById('previewContainer').innerHTML = '';
        const totalImages = originalImages.filter(item => item.type === 'image').length;
        processedCount = 0;
        totalToProcess = totalImages;
        startTime = Date.now();

        document.getElementById('progressTitle').textContent = '调整尺寸与格式';
        updateProgress(0, totalImages);

        for (let i = 0; i < originalImages.length; i++) {
            const item = originalImages[i];
            if (item.type !== 'image') continue;

            processedCount++;
            updateProgress(processedCount, totalImages, item.file.name);

            const img = item.img;
            const canvas = document.createElement('canvas');
            let width = currentWidthValue === 'custom' ? (widthInput || img.width) : parseInt(currentWidthValue) || img.width;
            let height = currentHeightValue === 'custom' ? (heightInput || img.height) : parseInt(currentHeightValue) || img.height;

            if (aspectRatio) {
                const ratio = img.height / img.width;
                if (currentDimensionMode === 'width' && currentWidthValue !== '') {
                    height = Math.round(width * ratio);
                } else if (currentDimensionMode === 'height' && currentHeightValue !== '') {
                    width = Math.round(height / ratio);
                } else if (currentDimensionMode === 'both' && currentWidthValue !== '' && currentHeightValue !== '') {
                    height = Math.round(width * ratio);
                }
            } else if (currentDimensionMode === 'width') {
                height = img.height;
            } else if (currentDimensionMode === 'height') {
                width = img.width;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            if (format !== 'image/png') {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            ctx.drawImage(img, 0, 0, width, height);

            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                const originalName = item.file.name.split('.').slice(0, -1).join('.');
                const extension = format.split('/')[1];
                const newFileName = `${originalName}_${width}x${height}.${extension}`;
                processedBlobs.push({ blob, name: newFileName });

                if (totalImages > 1) {
                    zip.file(newFileName, blob);
                }

                const thumbnail = document.createElement('img');
                thumbnail.src = URL.createObjectURL(blob);
                thumbnail.className = 'thumbnail';
                thumbnail.dataset.index = i;
                thumbnail.title = newFileName;
                document.getElementById('previewContainer').appendChild(thumbnail);
                
                if (processedCount % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            } catch (err) {
                showError(`处理图片 ${item.file.name} 失败：${err.message}`);
            }
        }

        document.getElementById('progressContainer').style.display = 'none';
        const downloadButton = document.getElementById('downloadButton');
        downloadButton.style.display = 'block';

        if (totalImages === 1) {
            downloadBlob = processedBlobs[0].blob;
            downloadFileName = processedBlobs[0].name;
            downloadButton.textContent = '下载处理后的图片';
        } else {
            try {
                updateProgress(processedCount, totalImages, '生成ZIP文件中...');
                downloadBlob = await zip.generateAsync({ type: 'blob' });
                downloadFileName = 'processed_images.zip';
                downloadButton.textContent = '下载 ZIP 压缩档';
            } catch (err) {
                showError(`生成 ZIP 文件失败：${err.message}`);
            }
        }
        
        enableUI();
        showSuccess('图片处理完成！');
    }

    async function processImageToBase64() {
        if (selectedFileType !== 'image' || !originalImages.some(item => item.type === 'image')) {
            showError('请先选择图片文件！');
            return;
        }

        disableUI();
        const zip = new JSZip();
        base64Data = [];
        document.getElementById('base64OutputContainer').innerHTML = '';
        const totalImages = originalImages.filter(item => item.type === 'image').length;
        processedCount = 0;
        totalToProcess = totalImages;
        startTime = Date.now();

        document.getElementById('progressTitle').textContent = '图片转 Base64';
        updateProgress(0, totalImages);

        for (let i = 0; i < originalImages.length; i++) {
            const item = originalImages[i];
            if (item.type !== 'image') continue;

            processedCount++;
            updateProgress(processedCount, totalImages, item.file.name);

            const canvas = document.createElement('canvas');
            canvas.width = item.img.width;
            canvas.height = item.img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(item.img, 0, 0);

            try {
                const base64String = canvas.toDataURL(currentFormatValue);
                base64Data.push({ name: item.file.name, base64: base64String });

                const outputDiv = document.createElement('div');
                outputDiv.className = 'file-item';
                outputDiv.innerHTML = `<strong>${item.file.name}</strong><br><textarea readonly>${base64String}</textarea>`;
                document.getElementById('base64OutputContainer').appendChild(outputDiv);

                if (totalImages > 1) {
                    zip.file(`${item.file.name}.txt`, base64String);
                }
                
                if (processedCount % 3 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            } catch (err) {
                showError(`图片 ${item.file.name} 转 Base64 失败：${err.message}`);
            }
        }

        document.getElementById('progressContainer').style.display = 'none';
        const downloadButton = document.getElementById('downloadButton');
        downloadButton.style.display = 'block';

        if (totalImages === 1) {
            const { base64, name } = base64Data[0];
            downloadBlob = new Blob([base64], { type: 'text/plain' });
            downloadFileName = `${name}.txt`;
            downloadButton.textContent = '下载 Base64 文件';
        } else {
            try {
                updateProgress(processedCount, totalImages, '生成ZIP文件中...');
                downloadBlob = await zip.generateAsync({ type: 'blob' });
                downloadFileName = 'base64_files.zip';
                downloadButton.textContent = '下载 Base64 ZIP 压缩档';
            } catch (err) {
                showError(`生成 Base64 ZIP 文件失败：${err.message}`);
            }
        }
        
        enableUI();
        showSuccess('Base64转换完成！');
    }

    async function processBase64ToImage() {
        let base64String = document.getElementById('base64Text').value.trim();
        const format = currentFormatValue;
        const qualityInput = parseInt(document.getElementById('qualityInput').value);
        const quality = currentQualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentQualityValue);
        const base64Files = originalImages.filter(item => item.type === 'base64');

        if (!base64String && base64Files.length === 0) {
            showError('请输入 Base64 字符串或选择 Base64 文件！');
            return;
        }

        if (selectedFileType === 'image' && !base64String) {
            showError('请选择 Base64 文件或输入 Base64 字符串！');
            return;
        }

        disableUI();
        const zip = new JSZip();
        processedBlobs = [];
        document.getElementById('previewContainer').innerHTML = '';
        const totalItems = (base64String ? 1 : 0) + base64Files.length;
        processedCount = 0;
        totalToProcess = totalItems;
        startTime = Date.now();

        document.getElementById('progressTitle').textContent = 'Base64 转图片';
        updateProgress(0, totalItems);

        if (base64String) {
            processedCount++;
            updateProgress(processedCount, totalItems, 'Base64字符串');

            let validBase64 = base64String;
            const prefixes = [
                'data:image/jpeg;base64,',
                'data:image/png;base64,',
                'data:image/webp;base64,',
                'data:image/gif;base64,'
            ];
            if (!base64String.startsWith('data:image/')) {
                for (let prefix of prefixes) {
                    const testString = prefix + base64String;
                    const isValid = await tryImageLoad(null, testString, 0, false);
                    if (isValid) {
                        validBase64 = testString;
                        break;
                    }
                }
            }

            try {
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = validBase64;
                });
                
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                const fileName = `converted_image_${Date.now()}.${format.split('/')[1]}`;
                processedBlobs.push({ blob, name: fileName });

                const thumbnail = document.createElement('img');
                thumbnail.src = URL.createObjectURL(blob);
                thumbnail.className = 'thumbnail';
                thumbnail.title = fileName;
                document.getElementById('previewContainer').appendChild(thumbnail);

                if (base64Files.length > 0) {
                    zip.file(fileName, blob);
                } else {
                    const downloadButton = document.getElementById('downloadButton');
                    downloadButton.style.display = 'block';
                    downloadBlob = blob;
                    downloadFileName = fileName;
                    downloadButton.textContent = '下载转换后的图片';
                }
            } catch (err) {
                showError('无法加载 Base64 字符串，请确认是否为有效的图片 Base64 字符串！');
            }
        }

        for (let i = 0; i < base64Files.length; i++) {
            const item = base64Files[i];
            processedCount++;
            updateProgress(processedCount, totalItems, item.file.name);

            try {
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = item.base64;
                });
                
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                const originalName = item.file.name.split('.').slice(0, -1).join('.');
                const extension = format.split('/')[1];
                const newFileName = `${originalName}.${extension}`;
                processedBlobs.push({ blob, name: newFileName });
                zip.file(newFileName, blob);

                const thumbnail = document.createElement('img');
                thumbnail.src = URL.createObjectURL(blob);
                thumbnail.className = 'thumbnail';
                thumbnail.dataset.index = originalImages.indexOf(item);
                thumbnail.title = newFileName;
                document.getElementById('previewContainer').appendChild(thumbnail);
                
                if (processedCount % 3 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            } catch (err) {
                showError(`无法加载 Base64 文件：${item.file.name}，请确认内容是否为有效的图片 Base64 字符串！`);
            }
        }

        if (base64Files.length > 0) {
            try {
                updateProgress(processedCount, totalItems, '生成ZIP文件中...');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const downloadButton = document.getElementById('downloadButton');
                downloadButton.style.display = 'block';
                downloadBlob = zipBlob;
                downloadFileName = 'converted_images.zip';
                downloadButton.textContent = '下载转换后的图片 ZIP 压缩档';
            } catch (err) {
                showError(`生成 ZIP 文件失败：${err.message}`);
            }
        }

        document.getElementById('progressContainer').style.display = 'none';
        enableUI();
        showSuccess('Base64转图片完成！');
    }

    // 初始化
    window.onload = function() {
        switchMode('resize');
        updateProcessButtons();
        if (!checkDirectorySupport()) {
            showError('警告：此浏览器不支持文件夹选择，请使用 Chrome、Edge 或 Safari！');
        }
    };
</script>
</body>
</html>
