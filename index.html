<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENG 圖片處理工具 v3.1 - 問題修復版</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #0033A0;
            --secondary-color: #005B99;
            --background-color: #E6F0FA;
            --light-background: #F5F8FA;
            --error-color: #ff3333;
            --success-color: #33cc33;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-background);
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        h1 {
            color: var(--primary-color);
            font-size: 24px;
            margin: 0 0 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .version {
            font-size: 14px;
            color: var(--secondary-color);
            font-weight: normal;
        }
        .section {
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .file-button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-button, .clear-button {
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        .file-button:hover, .clear-button:hover {
            background-color: var(--secondary-color);
            color: #FFFFFF;
        }
        .process-button {
            font-size: 18px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        .process-button:hover {
            background-color: var(--secondary-color);
            color: #FFFFFF;
        }
        .process-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #downloadButton {
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 4px;
            color: #FFFFFF;
            display: none;
            transition: background-color 0.2s;
        }
        #downloadButton:hover {
            background-color: var(--primary-color);
        }
        #fileList {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            background-color: #FFFFFF;
        }
        .file-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .thumbnail {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-size: 12px;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            resize: vertical;
            background-color: #FFFFFF;
            padding: 8px;
        }
        .hidden {
            display: none !important;
        }
        .mode-specific {
            display: none;
        }
        .controls div {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        label {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 500;
            min-width: 80px;
        }
        input[type="number"] {
            width: 100px;
            padding: 6px;
            font-size: 14px;
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            background-color: #FFFFFF;
        }
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .mode-buttons, .dimension-buttons, .size-buttons, .quality-buttons, .format-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .mode-button, .dimension-button, .size-button, .quality-button, .format-button {
            font-size: 14px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            color: var(--secondary-color);
            transition: all 0.2s;
        }
        .mode-button.active, .dimension-button.active, .size-button.active, .quality-button.active, .format-button.active {
            background-color: var(--primary-color);
            color: #FFFFFF;
            border-color: var(--primary-color);
        }
        .mode-button:hover, .dimension-button:hover, .size-button:hover, .quality-button:hover, .format-button:hover {
            background-color: var(--secondary-color);
            color: #FFFFFF;
        }
        .progress-container {
            display: none;
            margin-top: 10px;
            width: 100%;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--background-color);
            border: 1px solid var(--secondary-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 12px;
            color: var(--primary-color);
            text-align: center;
            margin-top: 5px;
        }
        .error-message {
            display: none;
            background-color: #ffe6e6;
            border: 1px solid var(--error-color);
            padding: 10px;
            border-radius: 4px;
            color: var(--error-color);
            font-size: 12px;
            margin-top: 10px;
        }
        .success-message {
            display: none;
            background-color: #e6ffe6;
            border: 1px solid var(--success-color);
            padding: 10px;
            border-radius: 4px;
            color: var(--success-color);
            font-size: 12px;
            margin-top: 10px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
            color: #005B99;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--secondary-color);
            color: #FFFFFF;
            text-align: center;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .help-text {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 5px;
        }
        .performance-note {
            font-size: 12px;
            color: var(--secondary-color);
            background-color: #fff;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid var(--secondary-color);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-ready {
            background-color: var(--success-color);
        }
        .status-processing {
            background-color: orange;
        }
        .status-complete {
            background-color: var(--secondary-color);
        }
        .sub-progress {
            margin-top: 10px;
            display: none;
        }
        .sub-progress .progress-header {
            font-size: 12px;
        }
        .sub-progress .progress-bar {
            height: 15px;
        }
        .base64-quality-container {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TENG 圖片處理工具 <span class="version">v3.1 - 問題修復版</span></h1>
        
        <div class="section">
            <label>處理模式</label>
            <div class="mode-buttons">
                <button class="mode-button active" data-mode="resize">尺寸調整與格式轉換</button>
                <button class="mode-button" data-mode="base64">Base64 互轉</button>
            </div>
        </div>
        
        <div class="section file-button-container">
            <div id="imageFileInputContainer">
                <label>圖片檔案</label>
                <button class="file-button" id="imageButton">選擇圖片</button>
                <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
                <div class="help-text">支援 JPEG, PNG, GIF, WEBP</div>
            </div>
            <div id="base64FileInputContainer" class="mode-specific" data-mode="base64">
                <label>Base64 檔案</label>
                <button class="file-button" id="base64FileButton">選擇檔案</button>
                <input type="file" id="base64FileInput" accept=".txt" multiple class="hidden">
                <div class="help-text">支援 .txt 檔案</div>
            </div>
            <div>
                <label>清空</label>
                <button class="clear-button" id="clearButton">清空檔案</button>
            </div>
        </div>
        
        <div class="section">
            <h3 id="fileListHeader" style="margin: 0; font-size: 16px; color: #0033A0;">
                <span class="status-indicator status-ready"></span>已選擇的檔案：<span id="fileCount">0</span> 張
            </h3>
            <div id="fileList"></div>
        </div>
        
        <div id="resizeOptions" class="section mode-specific controls" data-mode="resize">
            <div>
                <label>尺寸設定</label>
                <div class="dimension-buttons">
                    <button class="dimension-button active" data-mode="width">固定寬度</button>
                    <button class="dimension-button" data-mode="height">固定高度</button>
                    <button class="dimension-button" data-mode="both">寬度與高度</button>
                </div>
            </div>
            <div id="widthContainer">
                <label>寬度 (px)</label>
                <div class="size-buttons">
                    <button class="size-button" data-value="256">256</button>
                    <button class="size-button" data-value="512">512</button>
                    <button class="size-button active" data-value="1024">1024</button>
                    <button class="size-button" data-value="1280">1280</button>
                    <button class="size-button" data-value="custom">自訂</button>
                </div>
                <input type="number" id="widthInput" min="1" class="hidden" placeholder="輸入寬度">
            </div>
            <div id="heightContainer">
                <label>高度 (px)</label>
                <div class="size-buttons">
                    <button class="size-button" data-value="256">256</button>
                    <button class="size-button" data-value="512">512</button>
                    <button class="size-button active" data-value="1024">1024</button>
                    <button class="size-button" data-value="1280">1280</button>
                    <button class="size-button" data-value="custom">自訂</button>
                </div>
                <input type="number" id="heightInput" min="1" class="hidden" placeholder="輸入高度">
            </div>
            <div>
                <label>保持比例</label>
                <input type="checkbox" id="aspectRatio" checked>
            </div>
            <div id="qualityContainer">
                <label>品質</label>
                <div class="quality-buttons">
                    <button class="quality-button" data-value="0.5">50%</button>
                    <button class="quality-button" data-value="0.7">70%</button>
                    <button class="quality-button active" data-value="0.9">90%</button>
                    <button class="quality-button" data-value="0.95">95%</button>
                    <button class="quality-button" data-value="custom">自訂</button>
                </div>
                <input type="number" id="qualityInput" min="0" max="100" class="hidden" placeholder="0-100">
            </div>
        </div>
        
        <div id="base64InputSection" class="section mode-specific" data-mode="base64">
            <label>Base64 字串</label>
            <textarea id="base64Text" placeholder="輸入 Base64 字串（例如 data:image/jpeg;base64,...）"></textarea>
            
            <div class="base64-quality-container">
                <label>輸出品質</label>
                <div class="quality-buttons">
                    <button class="quality-button" data-value="0.5">50%</button>
                    <button class="quality-button" data-value="0.7">70%</button>
                    <button class="quality-button active" data-value="0.9">90%</button>
                    <button class="quality-button" data-value="0.95">95%</button>
                    <button class="quality-button" data-value="custom">自訂</button>
                </div>
                <input type="number" id="base64QualityInput" min="0" max="100" class="hidden" placeholder="0-100" value="90">
            </div>
        </div>
        
        <div class="section">
            <label>輸出格式</label>
            <div class="format-buttons">
                <button class="format-button active" data-value="image/jpeg">JPEG</button>
                <button class="format-button" data-value="image/png">PNG</button>
                <button class="format-button" data-value="image/webp">WebP</button>
            </div>
        </div>
        
        <div class="performance-note">
            <strong>效能提示：</strong> 處理大量圖片時，系統會自動分批處理以避免瀏覽器卡頓。處理過程中請勿關閉頁面。
        </div>
        
        <div class="section">
            <div class="file-button-container" id="processButtonsContainer">
                <button id="resizeButton" class="process-button mode-specific" data-mode="resize">調整尺寸與格式</button>
                <button id="toBase64Button" class="process-button mode-specific" data-mode="base64">圖片轉 Base64</button>
                <button id="fromBase64Button" class="process-button mode-specific" data-mode="base64">Base64 轉圖片</button>
            </div>
        </div>
        
        <div class="section progress-container" id="progressContainer">
            <div class="progress-header">
                <span id="progressTitle">處理進度</span>
                <span id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">等待中...</div>
            
            <!-- 子進度條 -->
            <div class="sub-progress" id="subProgressContainer">
                <div class="progress-header">
                    <span>當前檔案處理進度</span>
                    <span id="subProgressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="subProgressFill" style="background-color: #4CAF50;"></div>
                </div>
                <div class="progress-text" id="subProgressText">等待中...</div>
            </div>
            
            <div id="timeRemaining" class="progress-text"></div>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        
        <div class="section">
            <button id="downloadButton">下載結果</button>
        </div>
        
        <div class="section">
            <h3 style="margin: 0; font-size: 16px; color: #0033A0;">縮圖預覽</h3>
            <div id="previewContainer" class="thumbnail-container"></div>
        </div>
        
        <div id="base64Output" class="section mode-specific" data-mode="base64">
            <h3 style="margin: 0; font-size: 16px; color: #0033A0;">Base64 內容</h3>
            <div id="base64OutputContainer"></div>
        </div>
        
        <div class="tooltip">
            <span>使用說明</span>
            <span class="tooltip-text">支援圖片尺寸調整、格式轉換（尺寸調整預設 JPEG，Base64 模式預設 PNG，品質 90%）及 Base64 互轉。多檔案打包為 ZIP。</span>
        </div>
    </div>

    <script>
        // 變量定義
        let originalImages = [];
        let processedBlobs = [];
        let base64Data = [];
        let downloadBlob = null;
        let downloadFileName = '';
        let currentDimensionMode = 'width';
        let currentWidthValue = '1024';
        let currentHeightValue = '1024';
        let currentQualityValue = '0.9';
        let currentBase64QualityValue = '0.9';
        let currentFormatValue = 'image/jpeg';
        let isProcessing = false;
        let startTime = null;
        let processedCount = 0;
        let totalToProcess = 0;
        let selectedFileType = null;

        // DOM 元素引用
        const elements = {
            modeButtons: document.querySelectorAll('.mode-button'),
            dimensionButtons: document.querySelectorAll('.dimension-button'),
            sizeButtons: document.querySelectorAll('.size-button'),
            qualityButtons: document.querySelectorAll('.quality-button'),
            formatButtons: document.querySelectorAll('.format-button'),
            imageInput: document.getElementById('imageInput'),
            base64FileInput: document.getElementById('base64FileInput'),
            imageButton: document.getElementById('imageButton'),
            base64FileButton: document.getElementById('base64FileButton'),
            clearButton: document.getElementById('clearButton'),
            fileList: document.getElementById('fileList'),
            fileCount: document.getElementById('fileCount'),
            resizeButton: document.getElementById('resizeButton'),
            toBase64Button: document.getElementById('toBase64Button'),
            fromBase64Button: document.getElementById('fromBase64Button'),
            downloadButton: document.getElementById('downloadButton'),
            progressContainer: document.getElementById('progressContainer'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            progressPercentage: document.getElementById('progressPercentage'),
            subProgressContainer: document.getElementById('subProgressContainer'),
            subProgressFill: document.getElementById('subProgressFill'),
            subProgressText: document.getElementById('subProgressText'),
            subProgressPercentage: document.getElementById('subProgressPercentage'),
            timeRemaining: document.getElementById('timeRemaining'),
            errorMessage: document.getElementById('errorMessage'),
            successMessage: document.getElementById('successMessage'),
            previewContainer: document.getElementById('previewContainer'),
            base64OutputContainer: document.getElementById('base64OutputContainer'),
            base64Text: document.getElementById('base64Text'),
            widthInput: document.getElementById('widthInput'),
            heightInput: document.getElementById('heightInput'),
            qualityInput: document.getElementById('qualityInput'),
            base64QualityInput: document.getElementById('base64QualityInput'),
            aspectRatio: document.getElementById('aspectRatio')
        };

        // 初始化函數
        function init() {
            // 綁定事件監聽器
            bindEventListeners();
            
            // 初始化模式
            switchMode('resize');
            
            // 更新處理按鈕狀態
            updateProcessButtons();
        }

        // 綁定事件監聽器
        function bindEventListeners() {
            // 模式切換按鈕
            elements.modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchMode(button.dataset.mode);
                });
            });

            // 尺寸模式按鈕
            elements.dimensionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchDimensionMode(button.dataset.mode);
                });
            });

            // 尺寸按鈕
            elements.sizeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.closest('.size-buttons').parentElement.id.includes('width') ? 'width' : 'height';
                    setSize(type, button.dataset.value);
                });
            });

            // 品質按鈕
            elements.qualityButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    if (e.target.closest('.base64-quality-container')) {
                        setBase64Quality(button.dataset.value);
                    } else {
                        setQuality(button.dataset.value);
                    }
                });
            });

            // 格式按鈕
            elements.formatButtons.forEach(button => {
                button.addEventListener('click', () => {
                    setFormat(button.dataset.value);
                });
            });

            // 檔案選擇按鈕
            elements.imageButton.addEventListener('click', () => elements.imageInput.click());
            elements.base64FileButton.addEventListener('click', () => elements.base64FileInput.click());
            elements.clearButton.addEventListener('click', clearFiles);

            // 檔案輸入變化
            elements.imageInput.addEventListener('change', (e) => handleFileSelect(e, 'image'));
            elements.base64FileInput.addEventListener('change', (e) => handleFileSelect(e, 'base64'));

            // 處理按鈕
            elements.resizeButton.addEventListener('click', processResize);
            elements.toBase64Button.addEventListener('click', processImageToBase64);
            elements.fromBase64Button.addEventListener('click', processBase64ToImage);
            elements.downloadButton.addEventListener('click', handleDownload);

            // 輸入框事件
            elements.widthInput.addEventListener('input', debounce(updateDimensions, 300));
            elements.heightInput.addEventListener('input', debounce(updateDimensions, 300));
            elements.qualityInput.addEventListener('input', updateFileList);
            elements.aspectRatio.addEventListener('change', updateDimensions);
        }

        // 模式切換
        function switchMode(mode) {
            if (isProcessing) {
                showError('請等待當前處理完成後再切換模式');
                return;
            }
            
            // 更新按鈕狀態
            elements.modeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // 顯示/隱藏模式特定內容
            document.querySelectorAll('.mode-specific').forEach(el => {
                el.style.display = el.dataset.mode === mode ? 'block' : 'none';
            });
            
            // 設置預設格式和品質
            if (mode === 'resize') {
                currentFormatValue = 'image/jpeg';
                currentQualityValue = '0.9';
            } else if (mode === 'base64') {
                currentFormatValue = 'image/jpeg';
                currentBase64QualityValue = '0.9';
            }
            
            // 更新按鈕狀態
            elements.formatButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentFormatValue);
            });
            
            elements.qualityButtons.forEach(btn => {
                if (btn.closest('#base64InputSection')) {
                    btn.classList.toggle('active', btn.dataset.value === currentBase64QualityValue);
                } else {
                    btn.classList.toggle('active', btn.dataset.value === currentQualityValue);
                }
            });
            
            // 更新品質容器顯示
            toggleQualityContainer();
            
            // 清空檔案
            clearFiles();
            
            // 如果是尺寸調整模式，初始化尺寸模式
            if (mode === 'resize') {
                switchDimensionMode(currentDimensionMode);
            }
            
            // 更新處理按鈕
            updateProcessButtons();
        }

        // 切換尺寸模式
        function switchDimensionMode(mode) {
            currentDimensionMode = mode;
            
            // 更新按鈕狀態
            elements.dimensionButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // 顯示/隱藏尺寸容器
            elements.widthInput.closest('div').style.display = mode === 'height' ? 'none' : 'block';
            elements.heightInput.closest('div').style.display = mode === 'width' ? 'none' : 'block';
            
            // 更新尺寸輸入
            updateDimensionInputs();
            
            // 更新檔案列表
            updateFileList();
        }

        // 設置尺寸
        function setSize(type, value) {
            const buttons = document.querySelectorAll(`#${type}Container .size-button`);
            
            // 更新按鈕狀態
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            
            // 顯示/隱藏輸入框
            const input = document.getElementById(`${type}Input`);
            input.classList.toggle('hidden', value !== 'custom');
            
            // 更新當前值
            if (type === 'width') {
                currentWidthValue = value;
            } else {
                currentHeightValue = value;
            }
            
            // 更新尺寸
            updateDimensions();
            
            // 更新檔案列表
            updateFileList();
        }

        // 設置品質
        function setQuality(value) {
            // 更新按鈕狀態
            document.querySelectorAll('#qualityContainer .quality-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            
            // 顯示/隱藏輸入框
            elements.qualityInput.classList.toggle('hidden', value !== 'custom');
            
            // 更新當前值
            currentQualityValue = value;
            
            // 更新檔案列表
            updateFileList();
        }

        // 設置Base64品質
        function setBase64Quality(value) {
            // 更新按鈕狀態
            document.querySelectorAll('#base64InputSection .quality-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            
            // 顯示/隱藏輸入框
            elements.base64QualityInput.classList.toggle('hidden', value !== 'custom');
            
            // 更新當前值
            currentBase64QualityValue = value;
        }

        // 設置格式
        function setFormat(value) {
            // 更新按鈕狀態
            elements.formatButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            
            // 更新當前值
            currentFormatValue = value;
            
            // 更新品質容器顯示
            toggleQualityContainer();
            
            // 更新檔案列表
            updateFileList();
        }

        // 切換品質容器顯示
        function toggleQualityContainer() {
            const qualityContainer = document.getElementById('qualityContainer');
            qualityContainer.style.display = currentFormatValue === 'image/png' ? 'none' : 'block';
            updateFileList();
        }

        // 清空檔案
        function clearFiles() {
            if (isProcessing) {
                showError('請等待當前處理完成後再清空檔案');
                return;
            }
            
            // 重置數據
            originalImages = [];
            processedBlobs = [];
            base64Data = [];
            selectedFileType = null;
            
            // 清空UI
            elements.fileList.innerHTML = '';
            elements.previewContainer.innerHTML = '';
            elements.base64OutputContainer.innerHTML = '';
            elements.base64Text.value = '';
            elements.downloadButton.style.display = 'none';
            elements.progressContainer.style.display = 'none';
            elements.fileCount.textContent = '0';
            
            // 重置狀態指示器
            document.querySelector('.status-indicator').className = 'status-indicator status-ready';
            
            // 重置尺寸和品質值
            currentWidthValue = '1024';
            currentHeightValue = '1024';
            currentQualityValue = '0.9';
            
            // 更新按鈕狀態
            document.querySelectorAll('.size-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === '1024');
            });
            
            document.querySelectorAll('.quality-button').forEach(btn => {
                if (!btn.closest('#base64InputSection')) {
                    btn.classList.toggle('active', btn.dataset.value === '0.9');
                }
            });
            
            // 隱藏輸入框
            elements.widthInput.classList.add('hidden');
            elements.heightInput.classList.add('hidden');
            elements.qualityInput.classList.add('hidden');
            
            // 更新格式按鈕狀態
            elements.formatButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentFormatValue);
            });
            
            // 更新處理按鈕
            updateProcessButtons();
            
            // 更新檔案列表
            updateFileList();
        }

        // 處理檔案選擇
        function handleFileSelect(e, type) {
            const files = e.target.files;
            if (!files || files.length === 0) {
                showError('未選擇任何檔案，請重新選擇！');
                return;
            }

            // 清空現有檔案（如果不追加）
            if (!e.target.hasAttribute('multiple')) {
                clearFiles();
            }

            let validFiles = Array.from(files);
            
            // 根據類型過濾檔案
            if (type === 'base64') {
                validFiles = validFiles.filter(file => file.name.toLowerCase().endsWith('.txt'));
                if (validFiles.length === 0) {
                    showError('請選擇包含 .txt 的檔案！');
                    return;
                }
            } else if (type === 'image') {
                validFiles = validFiles.filter(file => {
                    const ext = file.name.toLowerCase();
                    return ext.match(/\.(jpeg|jpg|png|gif|bmp|webp)$/);
                });
                if (validFiles.length === 0) {
                    showError('請選擇支援的圖片檔案（JPEG、PNG、GIF、BMP、WebP）！');
                    return;
                }
            }

            // 設置檔案類型
            selectedFileType = type;
            
            // 更新處理按鈕
            updateProcessButtons();

            // 顯示處理狀態
            document.querySelector('.status-indicator').className = 'status-indicator status-processing';
            elements.fileCount.textContent = validFiles.length;
            
            // 處理檔案
            processFilesInBatches(validFiles, type, 0);
        }

        // 分批處理檔案
        function processFilesInBatches(files, type, startIndex) {
            const batchSize = 1;
            const endIndex = Math.min(startIndex + batchSize, files.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const file = files[i];
                
                // 檢查是否已存在
                if (originalImages.some(img => img.file.name === file.name && img.file.size === file.size)) {
                    showError(`檔案 ${file.name} 已存在，請選擇其他檔案！`);
                    continue;
                }

                if (type === 'image') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        handleImageLoad(file, e.target.result, originalImages.length, 'image');
                        if (i === files.length - 1) {
                            document.querySelector('.status-indicator').className = 'status-indicator status-complete';
                        }
                    };
                    reader.readAsDataURL(file);
                } else if (type === 'base64') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        handleBase64FileLoad(file, e.target.result, originalImages.length);
                        if (i === files.length - 1) {
                            document.querySelector('.status-indicator').className = 'status-indicator status-complete';
                        }
                    };
                    reader.readAsText(file);
                }
            }
            
            // 繼續處理下一批
            if (endIndex < files.length) {
                setTimeout(() => {
                    processFilesInBatches(files, type, endIndex);
                }, 100);
            }
        }

        // 處理圖片載入
        function handleImageLoad(file, imageSrc, index, type) {
            const img = new Image();
            img.onload = function() {
                originalImages.push({ file, img, type, base64: type === 'image' ? imageSrc : null });
                updateFileList();
                
                // 添加縮略圖
                const thumbnail = document.createElement('img');
                thumbnail.src = imageSrc;
                thumbnail.className = 'thumbnail';
                thumbnail.dataset.index = index;
                thumbnail.title = file.name;
                elements.previewContainer.appendChild(thumbnail);
                
                // 如果是尺寸調整模式，更新尺寸輸入
                if (document.querySelector('.mode-button.active').dataset.mode === 'resize') {
                    updateDimensionInputs();
                }
            };
            img.onerror = function() {
                showError(`無法載入圖片：${file.name}，請確認檔案格式是否為 JPEG、PNG！`);
            };
            img.src = imageSrc;
        }

        // 處理Base64檔案載入
        async function handleBase64FileLoad(file, text, index) {
            let base64String = text.trim();
            if (!base64String) {
                showError(`Base64 檔案 ${file.name} 內容為空，請檢查檔案！`);
                return;
            }

            const prefixes = [
                'data:image/jpeg;base64,',
                'data:image/png;base64,',
                'data:image/webp;base64,',
                'data:image/gif;base64,'
            ];

            // 如果已經是data URL格式
            if (base64String.startsWith('data:image/')) {
                await tryImageLoad(file, base64String, index);
                return;
            }

            // 嘗試添加前綴
            for (let prefix of prefixes) {
                const testString = prefix + base64String;
                const isValid = await tryImageLoad(file, testString, index, false);
                if (isValid) {
                    originalImages.push({ file, img: new Image(), type: 'base64', base64: testString });
                    updateFileList();
                    
                    // 添加縮略圖
                    const thumbnail = document.createElement('img');
                    thumbnail.src = testString;
                    thumbnail.className = 'thumbnail';
                    thumbnail.dataset.index = index;
                    thumbnail.title = file.name;
                    elements.previewContainer.appendChild(thumbnail);
                    return;
                }
            }

            showError(`無法載入 Base64 檔案：${file.name}，請確認內容是否為有效的圖片 Base64 字串！`);
        }

        // 嘗試載入圖片
        async function tryImageLoad(file, base64String, index, addToImages = true) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    if (addToImages) {
                        originalImages.push({ file, img, type: 'base64', base64: base64String });
                        updateFileList();
                        
                        // 添加縮略圖
                        const thumbnail = document.createElement('img');
                        thumbnail.src = base64String;
                        thumbnail.className = 'thumbnail';
                        thumbnail.dataset.index = index;
                        thumbnail.title = file.name;
                        elements.previewContainer.appendChild(thumbnail);
                    }
                    resolve(true);
                };
                img.onerror = function() {
                    resolve(false);
                };
                img.src = base64String;
            });
        }

        // 更新檔案列表
        function updateFileList() {
            elements.fileList.innerHTML = '';
            const mode = document.querySelector('.mode-button.active').dataset.mode;
            elements.fileCount.textContent = originalImages.length;

            originalImages.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'file-item';
                let text = `${item.file.name} (${item.type === 'image' ? '圖片' : 'Base64'})`;
                
                if (mode === 'resize' && item.type === 'image') {
                    const widthInput = parseInt(elements.widthInput.value) || item.img.width;
                    const heightInput = parseInt(elements.heightInput.value) || item.img.height;
                    const dimensionMode = currentDimensionMode;
                    const aspectRatio = elements.aspectRatio.checked;

                    let width = dimensionMode !== 'height' && currentWidthValue === 'custom' ? widthInput : parseInt(currentWidthValue) || item.img.width;
                    let height = dimensionMode !== 'width' && currentHeightValue === 'custom' ? heightInput : parseInt(currentHeightValue) || item.img.height;

                    if (aspectRatio) {
                        const ratio = item.img.height / item.img.width;
                        if (dimensionMode === 'width' && currentWidthValue !== '') {
                            height = Math.round(width * ratio);
                        } else if (dimensionMode === 'height' && currentHeightValue !== '') {
                            width = Math.round(height / ratio);
                        } else if (dimensionMode === 'both' && currentWidthValue !== '' && currentHeightValue !== '') {
                            height = Math.round(width * ratio);
                        }
                    } else if (dimensionMode === 'width') {
                        height = item.img.height;
                    } else if (dimensionMode === 'height') {
                        width = item.img.width;
                    }

                    text += ` | 原尺寸: ${item.img.width}x${item.img.height}`;
                    if (width && height) {
                        text += ` | 調整後: ${width}x${height}`;
                    }
                }
                
                listItem.textContent = text;
                elements.fileList.appendChild(listItem);
            });
        }

        // 更新尺寸輸入
        function updateDimensionInputs() {
            if (!originalImages[0]) return;
            
            const width = originalImages[0].img.width;
            const height = originalImages[0].img.height;
            const options = ['256', '512', '1024', '1280'];
            
            currentWidthValue = options.includes(width.toString()) ? width.toString() : '1024';
            currentHeightValue = options.includes(height.toString()) ? height.toString() : '1024';
            
            // 更新按鈕狀態
            document.querySelectorAll('#widthContainer .size-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentWidthValue);
            });
            
            document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === currentHeightValue);
            });
            
            // 顯示/隱藏輸入框
            elements.widthInput.classList.toggle('hidden', currentWidthValue !== 'custom');
            elements.heightInput.classList.toggle('hidden', currentHeightValue !== 'custom');
            
            // 更新尺寸
            updateDimensions();
        }

        // 更新尺寸
        function updateDimensions() {
            if (!originalImages[0]) return;

            const widthInput = parseInt(elements.widthInput.value) || 0;
            const heightInput = parseInt(elements.heightInput.value) || 0;
            const aspectRatio = elements.aspectRatio.checked;

            let width = currentWidthValue === 'custom' ? (widthInput || originalImages[0].img.width) : parseInt(currentWidthValue);
            let height = currentHeightValue === 'custom' ? (heightInput || originalImages[0].img.height) : parseInt(currentHeightValue);

            if (aspectRatio) {
                const ratio = originalImages[0].img.height / originalImages[0].img.width;
                if (currentDimensionMode === 'width' && width > 0) {
                    currentHeightValue = 'custom';
                    height = Math.round(width * ratio);
                    elements.heightInput.value = height;
                    
                    document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === 'custom');
                    });
                    
                    if (!elements.heightInput.closest('div').classList.contains('hidden')) {
                        elements.heightInput.classList.remove('hidden');
                    }
                } else if (currentDimensionMode === 'height' && height > 0) {
                    currentWidthValue = 'custom';
                    width = Math.round(height / ratio);
                    elements.widthInput.value = width;
                    
                    document.querySelectorAll('#widthContainer .size-button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === 'custom');
                    });
                    
                    if (!elements.widthInput.closest('div').classList.contains('hidden')) {
                        elements.widthInput.classList.remove('hidden');
                    }
                } else if (currentDimensionMode === 'both' && width > 0) {
                    currentHeightValue = 'custom';
                    height = Math.round(width * ratio);
                    elements.heightInput.value = height;
                    
                    document.querySelectorAll('#heightContainer .size-button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.value === 'custom');
                    });
                    
                    elements.heightInput.classList.remove('hidden');
                }
            }
            
            updateFileList();
        }

        // 更新處理按鈕
        function updateProcessButtons() {
            const mode = document.querySelector('.mode-button.active').dataset.mode;
            
            // 重置所有按鈕為顯示狀態
            elements.resizeButton.style.display = 'block';
            elements.toBase64Button.style.display = 'block';
            elements.fromBase64Button.style.display = 'block';
            document.getElementById('imageFileInputContainer').style.display = 'block';
            document.getElementById('base64FileInputContainer').style.display = 'block';
            document.getElementById('qualityContainer').style.display = 'block';

            // 根據模式和選擇的檔案類型調整顯示
            if (mode === 'resize') {
                // 尺寸調整模式：隱藏Base64相關按鈕
                elements.toBase64Button.style.display = 'none';
                elements.fromBase64Button.style.display = 'none';
                document.getElementById('base64FileInputContainer').style.display = 'none';
            } else if (mode === 'base64') {
                // Base64模式：隱藏調整尺寸按鈕
                elements.resizeButton.style.display = 'none';
                document.getElementById('qualityContainer').style.display = 'none';
                
                // 根據選擇的檔案類型調整顯示
                if (selectedFileType === 'image') {
                    elements.fromBase64Button.style.display = 'none';
                    document.getElementById('base64FileInputContainer').style.display = 'none';
                } else if (selectedFileType === 'base64') {
                    elements.toBase64Button.style.display = 'none';
                    document.getElementById('imageFileInputContainer').style.display = 'none';
                }
            }
        }

        // 處理尺寸調整
        async function processResize() {
            if (originalImages.length === 0 || !originalImages.some(item => item.type === 'image')) {
                showError('請先選擇圖片檔案！');
                return;
            }

            disableUI();
            const format = currentFormatValue;
            const widthInput = parseInt(elements.widthInput.value);
            const heightInput = parseInt(elements.heightInput.value);
            const aspectRatio = elements.aspectRatio.checked;
            const qualityInput = parseInt(elements.qualityInput.value);
            const quality = currentQualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentQualityValue);

            const zip = new JSZip();
            processedBlobs = [];
            elements.previewContainer.innerHTML = '';
            const totalImages = originalImages.filter(item => item.type === 'image').length;
            processedCount = 0;
            totalToProcess = totalImages;
            startTime = Date.now();

            elements.progressContainer.style.display = 'block';
            elements.subProgressContainer.style.display = 'block';
            document.getElementById('progressTitle').textContent = '調整尺寸與格式';
            updateProgress(0, totalImages);

            for (let i = 0; i < originalImages.length; i++) {
                const item = originalImages[i];
                if (item.type !== 'image') continue;

                processedCount++;
                updateProgress(processedCount, totalImages, item.file.name, 0);

                const img = item.img;
                const canvas = document.createElement('canvas');
                let width = currentWidthValue === 'custom' ? (widthInput || img.width) : parseInt(currentWidthValue) || img.width;
                let height = currentHeightValue === 'custom' ? (heightInput || img.height) : parseInt(currentHeightValue) || img.height;

                if (aspectRatio) {
                    const ratio = img.height / img.width;
                    if (currentDimensionMode === 'width' && currentWidthValue !== '') {
                        height = Math.round(width * ratio);
                    } else if (currentDimensionMode === 'height' && currentHeightValue !== '') {
                        width = Math.round(height / ratio);
                    } else if (currentDimensionMode === 'both' && currentWidthValue !== '' && currentHeightValue !== '') {
                        height = Math.round(width * ratio);
                    }
                } else if (currentDimensionMode === 'width') {
                    height = img.height;
                } else if (currentDimensionMode === 'height') {
                    width = img.width;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                if (format !== 'image/png') {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                
                ctx.drawImage(img, 0, 0, width, height);

                try {
                    // 模擬處理進度
                    for (let progress = 0; progress <= 100; progress += 20) {
                        updateProgress(processedCount, totalImages, item.file.name, progress);
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                    const originalName = item.file.name.split('.').slice(0, -1).join('.');
                    const extension = format.split('/')[1];
                    const newFileName = `${originalName}_${width}x${height}.${extension}`;
                    processedBlobs.push({ blob, name: newFileName });

                    if (totalImages > 1) {
                        zip.file(newFileName, blob);
                    }

                    const thumbnail = document.createElement('img');
                    thumbnail.src = URL.createObjectURL(blob);
                    thumbnail.className = 'thumbnail';
                    thumbnail.dataset.index = i;
                    thumbnail.title = newFileName;
                    elements.previewContainer.appendChild(thumbnail);
                    
                    // 完成當前文件處理，子進度條設為100%
                    updateProgress(processedCount, totalImages, item.file.name, 100);
                    
                    if (processedCount % 5 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                } catch (err) {
                    showError(`處理圖片 ${item.file.name} 失敗：${err.message}`);
                }
            }

            elements.progressContainer.style.display = 'none';
            elements.downloadButton.style.display = 'block';

            if (totalImages === 1) {
                downloadBlob = processedBlobs[0].blob;
                downloadFileName = processedBlobs[0].name;
                elements.downloadButton.textContent = '下載處理後的圖片';
            } else {
                try {
                    updateProgress(processedCount, totalImages, '生成ZIP檔案中...', 0);
                    downloadBlob = await zip.generateAsync({ type: 'blob' });
                    downloadFileName = 'processed_images.zip';
                    elements.downloadButton.textContent = '下載 ZIP 壓縮檔';
                    
                    // 生成ZIP後隱藏進度條
                    setTimeout(() => {
                        elements.progressContainer.style.display = 'none';
                    }, 500);
                } catch (err) {
                    showError(`生成 ZIP 檔案失敗：${err.message}`);
                    elements.progressContainer.style.display = 'none';
                }
            }
            
            enableUI();
            showSuccess('圖片處理完成！');
        }

        // 處理圖片轉Base64
        async function processImageToBase64() {
            if (selectedFileType !== 'image' || !originalImages.some(item => item.type === 'image')) {
                showError('請先選擇圖片檔案！');
                return;
            }

            disableUI();
            const zip = new JSZip();
            base64Data = [];
            elements.base64OutputContainer.innerHTML = '';
            const totalImages = originalImages.filter(item => item.type === 'image').length;
            processedCount = 0;
            totalToProcess = totalImages;
            startTime = Date.now();

            elements.progressContainer.style.display = 'block';
            elements.subProgressContainer.style.display = 'block';
            document.getElementById('progressTitle').textContent = '圖片轉 Base64';
            updateProgress(0, totalImages);

            for (let i = 0; i < originalImages.length; i++) {
                const item = originalImages[i];
                if (item.type !== 'image') continue;

                processedCount++;
                updateProgress(processedCount, totalImages, item.file.name, 0);

                const canvas = document.createElement('canvas');
                canvas.width = item.img.width;
                canvas.height = item.img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(item.img, 0, 0);

                try {
                    // 模擬處理進度
                    for (let progress = 0; progress <= 100; progress += 20) {
                        updateProgress(processedCount, totalImages, item.file.name, progress);
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    // 使用Base64品質設定
                    const qualityInput = parseInt(elements.base64QualityInput.value);
                    const quality = currentBase64QualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentBase64QualityValue);
                    
                    const base64String = canvas.toDataURL(currentFormatValue, quality);
                    base64Data.push({ name: item.file.name, base64: base64String });

                    const outputDiv = document.createElement('div');
                    outputDiv.className = 'file-item';
                    outputDiv.innerHTML = `<strong>${item.file.name}</strong><br><textarea readonly>${base64String}</textarea>`;
                    elements.base64OutputContainer.appendChild(outputDiv);

                    if (totalImages > 1) {
                        zip.file(`${item.file.name}.txt`, base64String);
                    }
                    
                    // 完成當前文件處理，子進度條設為100%
                    updateProgress(processedCount, totalImages, item.file.name, 100);
                    
                    // 每次處理一個檔案後都讓UI更新
                    await new Promise(resolve => setTimeout(resolve, 10));
                } catch (err) {
                    showError(`圖片 ${item.file.name} 轉 Base64 失敗：${err.message}`);
                }
            }

            elements.progressContainer.style.display = 'none';
            elements.downloadButton.style.display = 'block';

            if (totalImages === 1) {
                const { base64, name } = base64Data[0];
                downloadBlob = new Blob([base64], { type: 'text/plain' });
                downloadFileName = `${name}.txt`;
                elements.downloadButton.textContent = '下載 Base64 檔案';
            } else {
                try {
                    updateProgress(processedCount, totalImages, '生成ZIP檔案中...', 0);
                    downloadBlob = await zip.generateAsync({ type: 'blob' });
                    downloadFileName = 'base64_files.zip';
                    elements.downloadButton.textContent = '下載 Base64 ZIP 壓縮檔';
                    
                    // 生成ZIP後隱藏進度條
                    setTimeout(() => {
                        elements.progressContainer.style.display = 'none';
                    }, 500);
                } catch (err) {
                    showError(`生成 Base64 ZIP 檔案失敗：${err.message}`);
                    elements.progressContainer.style.display = 'none';
                }
            }
            
            enableUI();
            showSuccess('Base64轉換完成！');
        }

        // 處理Base64轉圖片
        async function processBase64ToImage() {
            let base64String = elements.base64Text.value.trim();
            const format = currentFormatValue;
            const qualityInput = parseInt(elements.base64QualityInput.value);
            const quality = currentBase64QualityValue === 'custom' ? (qualityInput / 100) || 0.9 : parseFloat(currentBase64QualityValue);
            const base64Files = originalImages.filter(item => item.type === 'base64');

            if (!base64String && base64Files.length === 0) {
                showError('請輸入 Base64 字串或選擇 Base64 檔案！');
                return;
            }

            if (selectedFileType === 'image' && !base64String) {
                showError('請選擇 Base64 檔案或輸入 Base64 字串！');
                return;
            }

            disableUI();
            const zip = new JSZip();
            processedBlobs = [];
            elements.previewContainer.innerHTML = '';
            const totalItems = (base64String ? 1 : 0) + base64Files.length;
            processedCount = 0;
            totalToProcess = totalItems;
            startTime = Date.now();

            elements.progressContainer.style.display = 'block';
            elements.subProgressContainer.style.display = 'block';
            document.getElementById('progressTitle').textContent = 'Base64 轉圖片';
            updateProgress(0, totalItems);

            if (base64String) {
                processedCount++;
                updateProgress(processedCount, totalItems, 'Base64字串', 0);

                let validBase64 = base64String;
                const prefixes = [
                    'data:image/jpeg;base64,',
                    'data:image/png;base64,',
                    'data:image/webp;base64,',
                    'data:image/gif;base64,'
                ];
                
                if (!base64String.startsWith('data:image/')) {
                    for (let prefix of prefixes) {
                        const testString = prefix + base64String;
                        const isValid = await tryImageLoad(null, testString, 0, false);
                        if (isValid) {
                            validBase64 = testString;
                            break;
                        }
                    }
                }

                try {
                    // 模擬處理進度
                    for (let progress = 0; progress <= 100; progress += 20) {
                        updateProgress(processedCount, totalItems, 'Base64字串', progress);
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = validBase64;
                    });
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                    const fileName = `converted_image_${Date.now()}.${format.split('/')[1]}`;
                    processedBlobs.push({ blob, name: fileName });

                    const thumbnail = document.createElement('img');
                    thumbnail.src = URL.createObjectURL(blob);
                    thumbnail.className = 'thumbnail';
                    thumbnail.title = fileName;
                    elements.previewContainer.appendChild(thumbnail);

                    if (base64Files.length > 0) {
                        zip.file(fileName, blob);
                    } else {
                        elements.downloadButton.style.display = 'block';
                        downloadBlob = blob;
                        downloadFileName = fileName;
                        elements.downloadButton.textContent = '下載轉換後的圖片';
                    }
                    
                    // 完成當前文件處理，子進度條設為100%
                    updateProgress(processedCount, totalItems, 'Base64字串', 100);
                } catch (err) {
                    showError('無法載入 Base64 字串，請確認是否為有效的圖片 Base64 字串！');
                }
            }

            for (let i = 0; i < base64Files.length; i++) {
                const item = base64Files[i];
                processedCount++;
                updateProgress(processedCount, totalItems, item.file.name, 0);

                try {
                    // 模擬處理進度
                    for (let progress = 0; progress <= 100; progress += 20) {
                        updateProgress(processedCount, totalItems, item.file.name, progress);
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    const img = new Image();
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = item.base64;
                    });
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, format, format === 'image/png' ? 1.0 : quality));
                    const originalName = item.file.name.split('.').slice(0, -1).join('.');
                    const extension = format.split('/')[1];
                    const newFileName = `${originalName}.${extension}`;
                    processedBlobs.push({ blob, name: newFileName });
                    zip.file(newFileName, blob);

                    const thumbnail = document.createElement('img');
                    thumbnail.src = URL.createObjectURL(blob);
                    thumbnail.className = 'thumbnail';
                    thumbnail.dataset.index = originalImages.indexOf(item);
                    thumbnail.title = newFileName;
                    elements.previewContainer.appendChild(thumbnail);
                    
                    // 完成當前文件處理，子進度條設為100%
                    updateProgress(processedCount, totalItems, item.file.name, 100);
                    
                    // 每次處理一個檔案後都讓UI更新
                    await new Promise(resolve => setTimeout(resolve, 10));
                } catch (err) {
                    showError(`無法載入 Base64 檔案：${item.file.name}，請確認內容是否為有效的圖片 Base64 字串！`);
                }
            }

            if (base64Files.length > 0) {
                try {
                    updateProgress(processedCount, totalItems, '生成ZIP檔案中...', 0);
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    elements.downloadButton.style.display = 'block';
                    downloadBlob = zipBlob;
                    downloadFileName = 'converted_images.zip';
                    elements.downloadButton.textContent = '下載轉換後的圖片 ZIP 壓縮檔';
                    
                    // 生成ZIP後隱藏進度條
                    setTimeout(() => {
                        elements.progressContainer.style.display = 'none';
                    }, 500);
                } catch (err) {
                    showError(`生成 ZIP 檔案失敗：${err.message}`);
                    elements.progressContainer.style.display = 'none';
                }
            }

            elements.progressContainer.style.display = 'none';
            enableUI();
            showSuccess('Base64轉圖片完成！');
        }

        // 處理下載
        function handleDownload() {
            if (downloadBlob && downloadFileName) {
                saveAs(downloadBlob, downloadFileName);
            } else {
                showError('無可下載的檔案，請先處理檔案！');
            }
        }

        // 更新進度
        function updateProgress(current, total, processedItem = null, subPercentage = 0) {
            elements.progressContainer.style.display = 'block';
            const percentage = total > 0 ? (current / total) * 100 : 0;
            elements.progressFill.style.width = `${percentage}%`;
            elements.progressPercentage.textContent = `${Math.round(percentage)}%`;
            
            if (elements.subProgressFill && elements.subProgressText && elements.subProgressPercentage) {
                elements.subProgressFill.style.width = `${subPercentage}%`;
                elements.subProgressPercentage.textContent = `${Math.round(subPercentage)}%`;
            }
            
            if (processedItem) {
                elements.progressText.textContent = `處理中：${current}/${total} (${processedItem})`;
                if (elements.subProgressText) {
                    elements.subProgressText.textContent = `當前檔案: ${processedItem}`;
                }
            } else {
                elements.progressText.textContent = `處理中：${current}/${total}`;
            }
            
            if (startTime && current > 0) {
                const elapsedTime = (Date.now() - startTime) / 1000;
                const timePerItem = elapsedTime / current;
                const remainingItems = total - current;
                const remainingTime = timePerItem * remainingItems;
                
                if (remainingTime > 60) {
                    elements.timeRemaining.textContent = `預計剩餘時間：${Math.round(remainingTime / 60)} 分鐘`;
                } else {
                    elements.timeRemaining.textContent = `預計剩餘時間：${Math.round(remainingTime)} 秒`;
                }
            }
        }

        // 禁用UI
        function disableUI() {
            isProcessing = true;
            document.querySelectorAll('.file-button, .process-button, .clear-button').forEach(btn => {
                btn.disabled = true;
            });
            document.querySelector('.status-indicator').className = 'status-indicator status-processing';
        }

        // 啟用UI
        function enableUI() {
            isProcessing = false;
            document.querySelectorAll('.file-button, .process-button, .clear-button').forEach(btn => {
                btn.disabled = false;
            });
            document.querySelector('.status-indicator').className = 'status-indicator status-complete';
        }

        // 顯示錯誤訊息
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
            elements.successMessage.style.display = 'none';
            setTimeout(() => {
                elements.errorMessage.style.display = 'none';
            }, 5000);
        }

        // 顯示成功訊息
        function showSuccess(message) {
            elements.successMessage.textContent = message;
            elements.successMessage.style.display = 'block';
            elements.errorMessage.style.display = 'none';
            setTimeout(() => {
                elements.successMessage.style.display = 'none';
            }, 5000);
        }

        // 防抖函數
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 初始化
        window.onload = init;
    </script>
</body>
</html>
